name: OTA Pipeline

on:
  push:
    branches: [dev]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  FIRMWARE_NAME: "ninebot-controller"
  FILESYSTEM_NAME: "ninebot-fs"

jobs:
  test-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup PlatformIO
      run: pip install platformio
    
    - name: Build Dev Firmware
      run: |
        echo "Building dev firmware..."
        
        # Получаем короткий хеш коммита
        COMMIT_HASH=$(echo "${{ github.sha }}" | cut -c1-8)
        
        pio run -e huzzah
        
        SIZE=$(stat -c%s .pio/build/huzzah/firmware.bin)
        echo "Firmware size: $SIZE bytes"
        if [ $SIZE -gt 1000000 ]; then
          echo "⚠️ Warning: Firmware > 1MB, consider optimization"
        fi
    
    - name: Build Dev Filesystem
      run: |
        echo "Building dev Filesystem..."
        pio run -t buildfs -e huzzah
        
        # Проверяем размер файловой системы
        if [ -f ".pio/build/huzzah/spiffs.bin" ]; then
          FS_FILE=".pio/build/huzzah/spiffs.bin"
        elif [ -f ".pio/build/huzzah/littlefs.bin" ]; then
          FS_FILE=".pio/build/huzzah/littlefs.bin"
        else
          echo "⚠️ Warning: No filesystem image found"
          exit 0
        fi
        
        FS_SIZE=$(stat -c%s "$FS_FILE")
        echo "Filesystem size: $FS_SIZE bytes"

    - name: Upload Dev Build
      uses: actions/upload-artifact@v4
      with:
        name: dev-firmware
        path: |
          .pio/build/huzzah/firmware.bin
          .pio/build/huzzah/spiffs.bin
          .pio/build/huzzah/littlefs.bin
        retention-days: 7

  build-release:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract Version
      id: get_version
      run: |
        # Убираем 'refs/tags/v' из начала
        VERSION="${GITHUB_REF#refs/tags/v}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Setup PlatformIO
      run: pip install platformio
    
    - name: Build Release Firmware
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        
        # Чистая сборка
        pio run -e huzzah -t clean
        
        # Сборка с версией
        pio run -e huzzah
    
    - name: Build Release Filesystem
      run: |
        echo "Building Release Filesystem..."
        pio run -t buildfs -e huzzah

    - name: Generate OTA Files
      run: |
        mkdir -p release
        
        VERSION="${{ steps.get_version.outputs.version }}"
        BIN_PATH=".pio/build/huzzah/firmware.bin"
        
        # Копируем прошивку
        cp $BIN_PATH release/${{ env.FIRMWARE_NAME }}-$VERSION.bin
        
        # Копируем файловую систему (если есть)
        if [ -f ".pio/build/huzzah/spiffs.bin" ]; then
          cp .pio/build/huzzah/spiffs.bin release/${{ env.FILESYSTEM_NAME }}-$VERSION.bin
          FS_PATH=".pio/build/huzzah/spiffs.bin"
        elif [ -f ".pio/build/huzzah/littlefs.bin" ]; then
          cp .pio/build/huzzah/littlefs.bin release/${{ env.FILESYSTEM_NAME }}-$VERSION.bin
          FS_PATH=".pio/build/huzzah/littlefs.bin"
        else
          echo "No filesystem image to copy"
          FS_PATH=""
        fi
        
        # Вычисляем хеши для прошивки
        MD5=$(md5sum $BIN_PATH | awk '{print $1}')
        SHA256=$(sha256sum $BIN_PATH | awk '{print $1}')
        SIZE=$(stat -c%s $BIN_PATH)
        
        # Вычисляем хеши для файловой системы (если есть)
        if [ -n "$FS_PATH" ]; then
          FS_MD5=$(md5sum "$FS_PATH" | awk '{print $1}')
          FS_SHA256=$(sha256sum "$FS_PATH" | awk '{print $1}')
          FS_SIZE=$(stat -c%s "$FS_PATH")
        fi
        
        # Создаём firmware.json с информацией о файловой системе
        cat > release/firmware.json <<EOF
        {
          "version": "$VERSION",
          "firmware": {
            "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/${{ env.FIRMWARE_NAME }}-$VERSION.bin",
            "checksum": "$MD5",
            "sha256": "$SHA256",
            "size": $SIZE
          }
        EOF
        
        # Добавляем информацию о файловой системе, если она есть
        if [ -n "$FS_PATH" ]; then
          cat >> release/firmware.json <<EOF
          ,
          "filesystem": {
            "url": "https://github.com/${{ github.repository }}/releases/download/v$VERSION/${{ env.FILESYSTEM_NAME }}-$VERSION.bin",
            "checksum": "$FS_MD5",
            "sha256": "$FS_SHA256",
            "size": $FS_SIZE
          }
        EOF
        fi
        
        cat >> release/firmware.json <<EOF
          ,
          "build_date": "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        }
        EOF
        
        # Авто-сгенерированный changelog
        echo "# Release v$VERSION" > release/CHANGELOG.md
        echo "" >> release/CHANGELOG.md
        echo "## Changes since last release:" >> release/CHANGELOG.md
        echo "" >> release/CHANGELOG.md
        
        # Находим предыдущий тег
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREV_TAG" ]; then
          # Коммиты между тегами
          git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> release/CHANGELOG.md
        else
          # Последние 10 коммитов если первый тег
          git log --pretty=format:"- %s (%h)" -10 >> release/CHANGELOG.md
        fi
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "v${{ steps.get_version.outputs.version }}"
        body_path: release/CHANGELOG.md
        files: |
          release/*.bin
          release/*.json
          release/*.md
        draft: false
        prerelease: false
